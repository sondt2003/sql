CREATE DATABASE QLSACH;
USE QLSACH
IF OBJECT_ID('NGANHHOC') IS NOT NULL 
DROP TABLE NGANHHOC
GO 
CREATE TABLE NGANHHOC(
MANG VARCHAR(10) NOT NULL,
TENNG NVARCHAR(50) NULL,
CONSTRAINT PK_NGANHHOC PRIMARY KEY (MANG)
)
IF OBJECT_ID('LOPHOC') IS NOT NULL 
DROP TABLE LOPHOC
GO 
CREATE TABLE LOPHOC( 
MALOP VARCHAR(10) NOT NULL,
MANG VARCHAR(10) NULL,
TENLOP NVARCHAR(50) NULL,
CONSTRAINT PK_LOPHOC PRIMARY KEY (MALOP),
CONSTRAINT FK_LOPHOC_NGANHHOC FOREIGN KEY (MANG) REFERENCES NGANHHOC
)


IF OBJECT_ID('SINHVIEN') IS NOT NULL 
DROP TABLE SINHVIEN
GO 
CREATE TABLE SINHVIEN(
MASV VARCHAR(10) NOT NULL,
MALOP VARCHAR(10) NULL,
HOTEN NVARCHAR(50) NULL,
DIACHI NVARCHAR(50) NULL,
EMAIL VARCHAR(50) NULL,
SDT VARCHAR(15) NULL,
NGSINH DATETIME NULL,
NGHH DATETIME NULL,
CONSTRAINT PK_SINHVIEN PRIMARY KEY (MASV),
CONSTRAINT FK_SINHVIEN_LOPHOC FOREIGN KEY (MALOP) REFERENCES LOPHOC
)
IF OBJECT_ID('PHIEUMUON') IS NOT NULL 
DROP TABLE PHIEUMUON
GO 
CREATE TABLE PHIEUMUON( 
MAPHIEU VARCHAR(10) NOT NULL,
MASV VARCHAR(10) NULL,
NGAYMUON DATETIME NULL,
CONSTRAINT PK_PHIEUMUON PRIMARY KEY (MAPHIEU),
CONSTRAINT FK_PHIEUMUON_SINHVIEN FOREIGN KEY (MASV) REFERENCES SINHVIEN
)
--THỂ LOẠI
IF OBJECT_ID('THELOAI') IS NOT NULL 
DROP TABLE THELOAI
GO
CREATE TABLE THELOAI(
MATL VARCHAR(10) NOT NULL,
TENTL NVARCHAR(50) NULL,
CONSTRAINT PK_THELOAI PRIMARY KEY (MATL)
)
IF OBJECT_ID('SACH') IS NOT NULL 
DROP TABLE SACH
GO 
CREATE TABLE SACH(
MASACH VARCHAR(10) NOT NULL,
MATL VARCHAR(10) NULL,
TIEUDE NVARCHAR(50) NULL,
SOTRANG INT NULL,
SLBANSAO INT NULL,
GIABIA MONEY NULL,
NGAYNK DATETIME NULL,
NHAXB NVARCHAR(50) NULL,
VITRI NVARCHAR(50) NULL,
NHANXET NVARCHAR(50) NULL,
CONSTRAINT PK_SACH PRIMARY KEY (MASACH),
CONSTRAINT FK_SACH_THELOAI FOREIGN KEY (MATL) REFERENCES THELOAI
)
IF OBJECT_ID('TACGIA') IS NOT NULL 
DROP TABLE TACGIA
GO 
CREATE TABLE TACGIA(
MATG VARCHAR(10) NOT NULL,
HOTEN NVARCHAR(30) NULL,
BUTDANH NVARCHAR(50) NULL,
DIACHI NVARCHAR(50) NULL,
SDT VARCHAR(15) NULL,
CONSTRAINT PK_TACGIA PRIMARY KEY (MATG)
)
IF OBJECT_ID('SACH_TG') IS NOT NULL 
DROP TABLE SACH_TG
GO 
CREATE TABLE SACH_TG(
MASACH VARCHAR(10) NOT NULL,
MATG VARCHAR(10) NOT NULL,
CONSTRAINT PK_SACHTG PRIMARY KEY (MASACH,MATG),
CONSTRAINT FK_SACHTG_SACH FOREIGN KEY (MASACH) REFERENCES SACH,
CONSTRAINT FK_SACHTG_TACGIA FOREIGN KEY (MATG) REFERENCES TACGIA
)
IF OBJECT_ID('PHIEUMUONCT') IS NOT NULL 
DROP TABLE PHIEUMUONCT
GO 
CREATE TABLE PHIEUMUONCT(
MASACH VARCHAR(10) NOT NULL,
MAPHIEU VARCHAR(10) NOT NULL,
SOLUONG INT NULL,
CONSTRAINT PK_PHIEUMUONCT PRIMARY KEY (MASACH,MAPHIEU),
CONSTRAINT FK_PHIEUMUONCT_SACH FOREIGN KEY (MASACH) REFERENCES SACH,
CONSTRAINT FK_PHIEUMUONCT_PHIEUMUON FOREIGN KEY (MAPHIEU) REFERENCES PHIEUMUON
)
--NHAP LIEU

DELETE FROM NGANHHOC
INSERT INTO NGANHHOC VALUES
('WEB',N'THIẾT KẾ WEB'),
('MOD',N'LẬP TRÌNH MOBLIE'),
('DESIGN',N'THIẾT KẾ WEB'),
('MOD102',N'LẬP TRÌNH GAME'),
('COM1014',N'LẬP TRÌNH MÁY TÍNH')
DELETE FROM LOPHOC
INSERT LOPHOC VALUES
('F301','WEB',N'THIẾT KẾ'),
('F302','MOD',N'LẬP TRÌNH'),
('F303','DESIGN',N'THIẾT KẾ'),
('F304','MOD102',N'LẬP TRÌNH'),
('F305','COM1014',N'LẬP TRÌNH')


DELETE FROM SINHVIEN
INSERT SINHVIEN VALUES
('PH22824','F301',N'ĐẶNG TRƯỜNG SƠN',N'THÁI NGUYÊN','sondtph22824@edu.fpt.vn','0368722770','03/03/2003','04/04/2022'),
('PH22825','F302',N'VŨ VIỆT ĐỨC',N'NINH BÌNH','ducvvph22824@edu.fpt.vn','0368722723','03/29/2003','01/15/2022'),
('PH22826','F303',N'PHAN TIẾN QUÂN',N'HÀ NỘI','quanptph22824@edu.fpt.vn','0368722751','05/25/2003','04/29/2022'),
('PH22827','F304',N'ĐẶNG TRƯỜNG NAM',N'HÀ NỘI','namdtph22824@edu.fpt.vn','0368726770','09/30/2003','05/30/2022'),
('PH22828','F305',N'DOÃN TRÍ BÌNH',N'THÁI NGUYÊN','doandtph22822@edu.fpt.vn','0364722870','10/04/2003','01/7/2022')


DELETE FROM PHIEUMUON
INSERT PHIEUMUON VALUES
('MP01','PH22824','02/12/2022'),
('MP02','PH22825','01/13/2022'),
('MP03','PH22826','02/15/2022'),
('MP04','PH22827','02/16/2022'),
('MP05','PH22828','01/17/2022')

DELETE FROM THELOAI
INSERT THELOAI VALUES
('TL01',N'TRINH THÁM'),
('TL02',N'VIỄN TRINH'),
('TL03',N'DU KÍCH'),
('TL04',N'ANONYMOUS'),
('TL05',N'KHOA HỌC')

DELETE FROM SACH
INSERT SACH VALUES
('MS01','TL01',N'NHẬP VAI',100,50000,100000,'2/20/2019',N'KIM ĐỒNG',N'TỦ SÁCH THỨ 1',N'KHÔNG CÓ NHẬN XÉT'),
('MS02','TL02',N'HỖN HỢP',400,1000,55000,'4/19/2014',N'NGUYỄN DU',N'TỦ SÁCH THỨ 1',N'KHÔNG CÓ NHẬN XÉT'),
('MS03','TL03',N'HỖN HỢP',200,500,59000,'4/14/2017',N'PHAN VĂN CHIẾN',N'TỦ SÁCH THỨ 2',N'KHÔNG CÓ NHẬN XÉT'),
('MS04','TL04',N'HACKING',5400,100,55000,'4/14/2020',N'VŨ ĐỨC CHÍ',N'TỦ SÁCH THỨ 3',N'KHÔNG CÓ NHẬN XÉT'),
('MS05','TL05',N'VIỄN TƯỞNG',4400,11520,55000,'5/14/2020',N'PHAN TRỌNG PHÚ',N'TỦ SÁCH THỨ 3',N'KHÔNG CÓ NHẬN XÉT')

DELETE FROM PHIEUMUONCT
INSERT PHIEUMUONCT VALUES
('MS01','MP01',1),
('MS02','MP02',7),
('MS03','MP03',6),
('MS04','MP04',5),
('MS05','MP05',3)


DELETE FROM TACGIA
INSERT TACGIA VALUES
('MTG01',N'VŨ VĂN NAM',N'NAM CAO',N'HÀ NỘI','0368724771'),
('MTG02',N'VŨ TRÍ ĐIỂM',N'PHẠM XUÂN',N'HÀ NỘI','0368322771'),
('MTG03',N'VŨ BẢO ĐỨC',N'TÔ HOÀI',N'HÀ NỘI','0366722771'),
('MTG04',N'NAM VĂN SUNG',N'SAM SUNG',N'HÀ NỘI','0368722731'),
('MTG05',N'SÙNG A LỬ',N'SÙNG',N'HÀ NỘI','0368722271')



DELETE FROM SACH_TG
INSERT SACH_TG VALUES
('MS01','MTG01'),
('MS02','MTG02'),
('MS03','MTG03'),
('MS04','MTG04'),
('MS05','MTG05')
SELECT * FROM NGANHHOC;
SELECT * FROM LOPHOC;
SELECT * FROM SINHVIEN;
SELECT * FROM PHIEUMUON;
SELECT * FROM PHIEUMUONCT;
SELECT * FROM SACH;
SELECT * FROM THELOAI;
SELECT * FROM SACH_TG;
SELECT * FROM TACGIA;
--NOT EXISTS KHÔNG TỒN TẠI

SELECT * FROM PHIEUMUON;
SELECT * FROM PHIEUMUONCT;
--6.1
SELECT TIEUDE,SACH.MASACH,GIABIA,MATG,MATL FROM SACH JOIN SACH_TG ON SACH.MASACH =SACH_TG.MATG WHERE MATL ='IT';
SELECT PHIEUMUON.MAPHIEU,MASACH fROM PHIEUMUON JOIN PHIEUMUONCT ON PHIEUMUON.MAPHIEU =PHIEUMUONCT.MAPHIEU WHERE MONTH(NGAYMUON)=4 AND YEAR(NGAYMUON) =2022;
--6.2
SELECT PHIEUMUON.MAPHIEU,MASACH,NGAYMUON,MASV
FROM PHIEUMUON JOIN PHIEUMUONCT ON PHIEUMUONCT.MAPHIEU = PHIEUMUON.MAPHIEU
WHERE MONTH(NGAYMUON) = 1 AND YEAR(NGAYMUON) = 2022
--6.3
--THEM TRẠNG THÁI
ALTER TABLE PHIEUMUON 
ADD TRANGTHAI NVARCHAR(50)NULL
DEFAULT N'CHƯA TRẢ SÁCH' WITH VALUES
--6.4
SELECT SACH.MATL ,TENTL,COUNT(SACH.MATL)AS SLDAUSACH FROM THELOAI JOIN SACH ON THELOAI.MATL = SACH.MATL  GROUP BY SACH.MATL,TENTL
--6.5
SELECT COUNT(MASACH) AS SOLUOTMUON FROM PHIEUMUONCT
--6.6
SELECT *FROM SACH WHERE TIEUDE LIKE '%HACKING%'
--6.7
SELECT SINHVIEN.MASV,HOTEN,PHIEUMUON.MAPHIEU,TIEUDE,NGAYMUON,GETDATE() AS NGAYTRA FROM  SINHVIEN JOIN PHIEUMUON ON SINHVIEN.MASV = PHIEUMUON.MASV 
JOIN PHIEUMUONCT ON PHIEUMUON.MAPHIEU =PHIEUMUONCT.MAPHIEU
JOIN SACH ON PHIEUMUONCT.MASACH =SACH.MASACH
WHERE NGAYMUON IS NOT NULL
ORDER BY NGAYMUON
--6.8
SELECT  MASACH,COUNT(MASACH) FROM PHIEUMUONCT 
GROUP BY MASACH 
HAVING COUNT(MASACH) >0
--6.9
UPDATE SACH
SET GIABIA =GIABIA*0.7
WHERE YEAR(NGAYNK) <= 2014
--6.10
UPDATE PHIEUMUON
SET TRANGTHAI =N'ĐÃ TRẢ' WHERE MAPHIEU='MP01'
SELECT * FROM PHIEUMUON 
--6.11
SELECT PHIEUMUON.MAPHIEU,HOTEN,EMAIL,MASACH,NGAYMUON,
GETDATE()AS NGAYTRA,DATEDIFF(DAY,NGAYMUON,GETDATE()) AS SONGAY
FROM SINHVIEN JOIN PHIEUMUON ON PHIEUMUON.MASV = SINHVIEN.MASV
JOIN PHIEUMUONCT ON PHIEUMUONCT.MAPHIEU = PHIEUMUON.MAPHIEU
WHERE DATEDIFF (DAY,NGAYMUON,GETDATE()) > 7
--6.12
UPDATE SACH
SET SLBANSAO =SLBANSAO+5 WHERE MASACH IN (SELECT MASACH FROM PHIEUMUONCT GROUP BY  MASACH HAVING COUNT(MASACH)>0) 
SELECT * FROM SACH
--6.13
DELETE FROM PHIEUMUONCT
WHERE MAPHIEU IN (SELECT MAPHIEU FROM PHIEUMUON WHERE NGAYMUON BETWEEN '4/1/2022' AND '4/10/2022')
DELETE FROM PHIEUMUON
WHERE NGAYMUON BETWEEN '4/1/2022' AND '4.10/2022'